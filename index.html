<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arena di Verona Opera Festival - Entradas, Fechas y Artistas</title>
  <meta name="description" content="Explora los eventos del Festival de Ópera en la Arena de Verona. Encuentra fechas, artistas y compra tus entradas para las próximas representaciones.">
  <link rel="canonical" href="https://juanjohigueras.com/verona/index.html">

  <!-- Fuentes: Uso de 'font-display: swap' para asegurar que el texto sea visible mientras las fuentes se cargan. -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f9fafb;
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
    }
    /* Spinner */
    #spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border-left-color: #FFD700;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Botones principales con efecto destello */
    .btn-primary {
      position: relative;
      overflow: hidden;
      background: linear-gradient(to right, #facc15, #ca8a04);
      color: #000;
      padding: 0.5rem 1.5rem;
      border-radius: 9999px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-primary:hover {
      background: linear-gradient(to right, #eab308, #a16207);
      transform: scale(1.05);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    .btn-primary::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -30%;
      width: 40%;
      height: 200%;
      background: rgba(255, 255, 255, 0.5);
      transform: rotate(25deg);
      transition: left 0.7s ease;
    }
    .btn-primary:hover::before {
      left: 120%;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
      padding-top: 60px;
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }

    .close {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 25px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover, .close:focus {
      color: #000;
      text-decoration: none;
    }

    /* Línea divisoria en el pie de página */
    .divider-line {
      /* Estilo por defecto para móviles: línea horizontal */
      width: 100%;
      height: 1px;
      background-color: #ca8a04;
      margin: 2rem 0; /* Margen para separación */
    }

    /* Estilo para pantallas de escritorio: línea vertical */
    @media (min-width: 640px) { /* sm */
      .divider-line {
        height: 160px;
        width: 1px;
        margin: 0 2rem;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gradient-to-r from-[#003366] to-black py-10 shadow-lg border-b-4 border-[#ca8a04]">
    <div class="max-w-6xl mx-auto px-6 flex flex-col sm:flex-row items-center justify-between gap-6">
      <img src="https://juanjohigueras.com/verona/assets/logo-arena-white.png" alt="Logo del Festival de la Arena di Verona" class="h-20 sm:h-28">
      <div class="text-center sm:text-right">
        <h1 class="text-4xl sm:text-5xl font-bold text-[#facc15] drop-shadow-lg">
          <span id="festival-edition">Arena di Verona Opera Festival</span>
        </h1>
        <p class="text-xl sm:text-2xl font-medium text-[#facc15] mt-3 italic">
          The most Italian place on earth
        </p>
      </div>
    </div>
  </header>

  <main class="flex-1">
    <!-- Aviso -->
    <section class="max-w-6xl mx-auto px-6 mt-8">
      <div class="bg-red-50 border border-red-200 text-red-700 p-5 rounded-xl shadow-md text-center">
        <p class="text-lg">
          Esta no es la página oficial de la Fondazione Arena di Verona. Es una herramienta de visualización de datos. Los enlaces de <b>"Comprar Entradas"</b> y <b>"Ver Detalles"</b> te redirigirán a la página oficial. Para tu seguridad, verifica que la URL comience con <b>https://www.arena.it</b> antes de realizar cualquier pago.
        </p>
      </p>
    </section>

    <!-- Instrucción -->
    <section class="max-w-4xl mx-auto px-6 text-center mt-8">
      <p class="text-lg text-gray-700 leading-relaxed">
        Utiliza el formulario para encontrar óperas. Introduce una <b>Fecha ópera</b> para activar el filtro <b>Margen días</b>, que buscará eventos en un rango de días antes y después de la fecha seleccionada. Opcionalmente, puedes buscar por el nombre de un artista en el campo <b>Cast</b>.
      </p>
    </section>

    <!-- Filtros -->
    <section class="max-w-5xl mx-auto px-6 mt-10">
      <div class="bg-white border border-gray-200 rounded-2xl shadow-lg p-6">
        <h2 class="text-3xl font-bold text-gray-900 text-center mb-6">🎭 Filtrar Eventos</h2>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <div class="flex flex-col sm:flex-row gap-2 items-center w-full sm:w-auto">
            <label for="date-filter" class="font-medium text-gray-700">Fecha:</label>
            <input type="date" id="date-filter" class="px-4 py-2 rounded-full border border-gray-300 shadow-sm focus:ring-2 focus:ring-yellow-500 w-full sm:w-auto text-center" />
          </div>

          <div id="days-filter-container" class="hidden flex flex-col sm:flex-row gap-2 items-center w-full sm:w-auto">
            <label for="days-filter" class="font-medium text-gray-700">Margen días:</label>
            <input type="number" id="days-filter" value="3" min="0" class="px-4 py-2 rounded-full border border-gray-300 shadow-sm focus:ring-2 focus:ring-yellow-500 w-full sm:w-24 text-center" />
          </div>

          <div class="flex flex-col sm:flex-row gap-2 items-center w-full sm:w-auto">
            <label for="cast-filter" class="font-medium text-gray-700">Cast:</label>
            <input type="text" id="cast-filter" placeholder="ej. Anna Netrebko" class="px-4 py-2 rounded-full border border-gray-300 shadow-sm focus:ring-2 focus:ring-yellow-500 w-full sm:w-auto text-center" />
          </div>
        </div>

        <p id="validation-message" class="hidden text-sm text-red-500 mt-3 text-center">Formato de fecha no válido.</p>

        <div class="flex flex-col sm:flex-row gap-4 justify-center mt-6">
          <button id="filter-button" class="btn-primary font-medium text-base">Buscar</button>
          <button id="reset-button" class="bg-gradient-to-r from-[#003366] to-black text-white px-6 py-2 rounded-full font-medium text-base shadow-md hover:shadow-lg transform hover:scale-105 transition duration-300">
            Limpiar
          </button>
        </div>
      </div>
    </section>

    <!-- Listado de eventos -->
    <section class="max-w-6xl mx-auto px-6 mt-14">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold text-gray-900">Próximas Representaciones</h2>
        <hr class="mt-3 border-t-2 border-yellow-400 w-24 mx-auto">
      </div>
      <div id="events-container" class="grid gap-8 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <!-- El contenido se cargará dinámicamente aquí -->
      </div>
      <div id="loading-state" class="col-span-full flex flex-col items-center justify-center text-center mt-8">
          <p class="text-gray-500 text-xl animate-pulse">Cargando representaciones...</p>
          <div id="spinner" class="mt-4"></div>
      </div>
      <div id="error-message" class="hidden text-center mt-10 p-4 bg-red-100 text-red-700 rounded-lg border border-red-200">
        <p>Lo sentimos, no pudimos cargar los eventos. Por favor, asegúrate de que el servidor esté en funcionamiento.</p>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gradient-to-r from-[#003366] to-black text-gray-300 text-center py-6 mt-14 border-t-4 border-[#ca8a04]">
    <div class="max-w-6xl mx-auto px-6 flex flex-col sm:flex-row items-center justify-between">
      <div class="flex-1 flex flex-col items-center justify-center">
        <p class="text-base mb-4 text-gray-300 font-serif">
          Si has encontrado esta web útil, puedes invitarme a un prosecco en la <span id="footer-edition">103º</span> edición del festival de ópera en la Arena de Verona. Grazie Mile!
        </p>
        <a href="https://buymeacoffee.com/juanjohigub" target="_blank" rel="noopener noreferrer" class="inline-block">
          <button class="btn-primary flex items-center space-x-2 font-medium text-base">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 67.46 148.22" class="w-3 h-6">
                  <path d="M45.85,85.24c5.61-3.8,14.84-9.77,19.91-30.4C71.85,30.07,59.61,0,59.61,0H7.85S-4.39,30.07,1.7,54.84c5.07,20.63,14.3,26.6,19.91,30.4,5.61,3.8,7.96,8.14,7.96,16.29v39.27c-21.35-.18-23.53,7.42-23.53,7.42h55.38s-2.17-7.6-23.53-7.42v-39.27c0-8.14,2.35-12.49,7.96-16.29Z"/>
              </svg>
              <span>Invítame a un prosecco</span>
          </button>
        </a>
      </div>
      <!-- Separador de línea que se adapta según el tamaño de la pantalla -->
      <div class="divider-line"></div>
      <div class="flex-1 flex flex-col items-center justify-center mt-4 sm:mt-0">
        <p class="text-base mb-4 font-serif">Developed by juanjohigueras.com</p>
        <div class="inline-block bg-white rounded-xl p-3 shadow-md">
          <a href="https://www.juanjohigueras.com" target="_blank" rel="noopener noreferrer">
            <img src="https://juanjohigueras.com/verona/assets/logo-juanjo-white.png" alt="Logo de Juanjo Higueras" class="h-10 mx-auto">
          </a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Modal de Descripción -->
  <div id="operaModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3>
      <div class="h-1 w-full bg-gradient-to-r from-[#003366] to-black my-4 rounded-full"></div>
      <div id="modalDescription" class="text-gray-700 leading-relaxed"></div>
    </div>
  </div>

  <!-- Script -->
  <script>
    // Se utiliza un IIFE para evitar la contaminación del ámbito global.
    (() => {
      const eventsContainer = document.getElementById('events-container');
      const errorMessage = document.getElementById('error-message');
      const loadingState = document.getElementById('loading-state');
      const dateFilterInput = document.getElementById('date-filter');
      const daysFilterContainer = document.getElementById('days-filter-container');
      const daysFilterInput = document.getElementById('days-filter');
      const castFilterInput = document.getElementById('cast-filter');
      const validationMessage = document.getElementById('validation-message');
      const filterButton = document.getElementById('filter-button');
      const resetButton = document.getElementById('reset-button');
      const festivalEditionElement = document.getElementById('festival-edition');
      const footerEditionElement = document.getElementById('footer-edition');
      const operaModal = document.getElementById('operaModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalDescription = document.getElementById('modalDescription');
      const closeModalBtn = document.querySelector('.close');

      const aidaDescription = `Aida es una ópera en cuatro actos de Giuseppe Verdi. La trama se desarrolla en el antiguo Egipto, en un contexto de guerra entre Egipto y Etiopía. La ópera narra el trágico romance entre Radamés, un comandante egipcio, y Aida, una princesa etíope que ha sido esclavizada. Su amor es puesto a prueba por la rivalidad de Amneris, la hija del Faraón, que también ama a Radamés. El drama culmina con una traición, el juicio de Radamés y su fatal desenlace. Aunque existen varias producciones con diferentes directores (como Stefano Poda o Franco Zeffirelli), la música y el libreto de la ópera son los mismos.
      <br><br>
      <strong>Acto I:</strong> El ejército egipcio se prepara para la guerra contra Etiopía. Radamés es elegido comandante y, en secreto, sueña con su amada Aida. Sin embargo, Amneris, la princesa egipcia, sospecha de su amor por Aida y la interroga con astucia.
      <br><br>
      <strong>Acto II:</strong> Amneris se regocija por el regreso triunfal de Radamés, pero su desconfianza hacia Aida crece. El Faraón otorga la mano de Amneris a Radamés, mientras Aida se reencuentra con su padre, el rey de Etiopía, ahora prisionero, y él la obliga a sonsacarle a Radamés la ubicación del ejército egipcio.
      <br><br>
      <strong>Acto III:</strong> A orillas del río Nilo, Aida se encuentra con Radamés. El padre de Aida la convence para que le sonsaque los planes de guerra. Radamés, cegado por el amor, revela la información. Son descubiertos por Amneris y el sacerdote Ramfis, y Radamés es acusado de traición.
      <br><br>
      <strong>Acto IV:</strong> Radamés es juzgado por los sacerdotes y condenado a ser enterrado vivo. Aida, que logra colarse en el sepulcro, espera a Radamés para morir junto a él. Ambos sellan su amor en la tumba, mientras Amneris, fuera del sepulcro, llora su amor perdido.`;

      const operaDescriptions = {
        'Aida Ed. Stefano Poda': aidaDescription,
        'Aida Ed. Franco Zeffirelli': aidaDescription,
        'Nabucco': `Nabucco es una ópera en cuatro actos de Giuseppe Verdi. Ambientada en la antigua Babilonia (586 a.C.), narra la historia del rey Nabucodonosor II, quien somete al pueblo judío y los lleva al exilio. La ópera explora temas de poder, fe y redención a través de personajes como el rey, su hija Fenena, y la ambiciosa Abigaille. La obra es célebre por su emotivo coro "Va, pensiero" (el coro de los esclavos hebreos), que se ha convertido en un himno de esperanza y libertad para muchos.
        <br><br>
        <strong>Acto I:</strong> Los israelitas, invadidos por las tropas de Nabucco, se lamentan en el Templo de Salomón. Abigaille, la supuesta hija mayor de Nabucco, conspira para usurpar el trono, consumida por los celos hacia su hermana Fenena y su amor no correspondido por Ismael.
        <br><br>
        <strong>Acto II:</strong> Abigaille descubre un documento que revela que es una esclava y no la hija de Nabucco. Enfurecida, aprovecha la ausencia de Nabucco para autoproclamarse reina. El rey, al regresar, se proclama a sí mismo dios y es fulminado por un rayo, perdiendo la razón.
        <br><br>
        <strong>Acto III:</strong> Abigaille, ahora en el poder, engaña a un Nabucco mentalmente incapacitado para que firme la orden de ejecución de los hebreos. Nabucco se da cuenta de que también ha condenado a su amada hija Fenena.
        <br><br>
        <strong>Acto IV:</strong> Nabucco recupera la razón al presenciar la fe de su hija Fenena. Se arrepiente, se convierte al judaísmo, y ordena la liberación de los prisioneros. Abigaille, al ver sus planes frustrados, se envenena y muere pidiendo perdón.`,
        'Il Barbiere di Siviglia': `El Barbero de Sevilla (Il Barbiere di Siviglia) es una ópera bufa en dos actos de Gioachino Rossini. Se trata de una comedia llena de enredos y malentendidos. La trama sigue al joven y enamorado Conde Almaviva en su intento de casarse con la bella Rosina, pupila del avaro Doctor Bartolo. Con la ayuda del ingenioso barbero Fígaro, un maestro en las intrigas y los disfraces, el conde burla a Bartolo para conquistar el corazón de Rosina. La ópera es conocida por su humor, sus arias virtuosísticas y su ritmo frenético.
        <br><br>
        <strong>Acto I:</strong> El Conde Almaviva intenta cortejar a Rosina bajo la ventana de su casa. Con la ayuda del barbero Fígaro, se hace pasar por un estudiante pobre llamado Lindoro para ganar su amor. A continuación, se disfraza de soldado borracho para entrar en la casa de Bartolo, pero sus planes son frustrados y se produce un gran caos.
        <br><br>
        <strong>Acto II:</strong> El Conde Almaviva vuelve a la carga, esta vez disfrazado de maestro de música, en un intento de dar lecciones a Rosina y poder pasar tiempo con ella. A pesar de la vigilancia de Bartolo, los enredos culminan con la huida de la pareja, y el Conde revela su verdadera identidad. Bartolo, finalmente, resignado, accede al matrimonio.`,
        'La Bohème': `La Bohème es una ópera en cuatro actos de Giacomo Puccini. Ambientada en el barrio latino de París en el siglo XIX, relata la vida de un grupo de jóvenes artistas bohemios que luchan contra el hambre, el frío y la pobreza. El eje central es la trágica historia de amor entre el poeta Rodolfo y la costurera Mimì, una relación que florece y se desvanece con la fragilidad de la vida. La música de Puccini es lírica y emotiva, capturando la alegría, el dolor y la desesperación de la juventud.
        <br><br>
        <strong>Acto I:</strong> Rodolfo, el poeta, y sus amigos bohemios (el pintor Marcello, el músico Schaunard y el filósofo Colline) malviven en su desván parisino. Mimì, una vecina, aparece buscando una vela. Ambos se enamoran al instante mientras se buscan las llaves de la habitación, que Rodolfo había escondido a propósito.
        <br><br>
        <strong>Acto II:</strong> El grupo de amigos se reúne en el Café Momus, donde la alegría se desborda y el romance de Rodolfo y Mimì se consolida.
        <br><br>
        <strong>Acto III:</strong> Los amantes se separan debido a la enfermedad de Mimì y los celos de Rodolfo, quien no puede soportar verla sufrir. Sin embargo, al final del acto, se dan cuenta de que no pueden vivir el uno sin el otro y deciden permanecer juntos hasta la primavera.
        <br><br>
        <strong>Acto IV:</strong> De vuelta en el desván, los amigos se dan cuenta de que Mimì está muy enferma. Se reúnen para ayudarla. En sus últimos momentos, ella y Rodolfo reviven su amor, y Mimì muere rodeada de sus amigos.`,
        'La Traviata': `La Traviata es una ópera en tres actos de Giuseppe Verdi. Basada en la novela "La Dama de las Camelias" de Alexandre Dumas (hijo), cuenta la conmovedora y trágica historia de amor entre la cortesana parisina Violetta Valéry y el joven noble Alfredo Germont. A pesar de los prejuicios sociales, su amor florece, pero se ve amenazado por la intervención del padre de Alfredo, Giorgio Germont. La ópera es reconocida por su conmovedora trama, sus arias melódicas y su profundo dramatismo que explora temas de sacrificio y la hipocresía social.
        <br><br>
        <strong>Acto I:</strong> En una fiesta en París, Violetta conoce a Alfredo. Él le declara su amor. Aunque ella es reacia a dejar su vida de cortesana, se enamora de él.
        <br><br>
        <strong>Acto II:</strong> Violetta y Alfredo se han mudado al campo para vivir juntos. El padre de Alfredo, Giorgio Germont, le pide a Violetta que lo deje para proteger el honor de su familia. Violetta se sacrifica y regresa a París, dejando a Alfredo una nota de despedida.
        <br><br>
        <strong>Acto III:</strong> Violetta, gravemente enferma de tuberculosis, se encuentra sola y abandonada. Alfredo, que ha descubierto la verdad sobre su sacrificio, la visita y se reconcilian. Sin embargo, es demasiado tarde y Violetta muere en sus brazos.`,
        'Turandot': `Turandot es una ópera en tres actos de Giacomo Puccini, basada en una historia persa. La trama se sitúa en la antigua China, donde la fría princesa Turandot desafía a sus pretendientes a resolver tres acertijos. Si fallan, son decapitados. El príncipe Calàf, enamorado de ella, acepta el reto y logra resolverlos. Sin embargo, para ganarse su amor, le da a la princesa un acertijo propio. La ópera es célebre por el aria "Nessun dorma" y su exótica orquestación, aunque quedó inconclusa tras la muerte de Puccini y fue completada por Franco Alfano.
        <br><br>
        <strong>Acto I:</strong> El Príncipe de Persia falla en los acertijos de Turandot y es ejecutado ante la multitud. El Príncipe Calàf, un extranjero anónimo, ve a la Princesa Turandot y queda deslumbrado por su belleza, decidiendo enfrentar los acertijos.
        <br><br>
        <strong>Acto II:</strong> Calàf se presenta ante la corte y resuelve los tres acertijos. Turandot, horrifieda, le ruega a su padre que no la obligue a casarse. Calàf le da un acertijo propio: si ella descubre su nombre antes del amanecer, él morirá.
        <br><br>
        <strong>Acto III:</strong> Nadie duerme en Pekín esa noche mientras Turandot busca el nombre. Turandot captura a Liu, la esclava que acompaña al padre de Calàf, y la tortura para que lo revele, pero ella se suicida para proteger al príncipe. Calàf confronta a Turandot y la besa. Ella se enamora y confiesa su amor por él, proclamando su nombre como "Amor".`
      };
      
      const apiUrl = 'https://arena-gateway.vercel.app/events';
      const festivalInfoUrl = 'https://arena-gateway.vercel.app/festival-info';
      let allEventsData = [];

      function isValidDate(dateString) {
        const regex = /^\d{4}-\d{2}-\d{2}$/;
        return dateString.match(regex) !== null;
      }
      
      // Función para generar dinámicamente el marcado de datos JSON-LD
      function generateSchemaMarkup(events) {
        // Elimina el marcado de datos anterior si existe
        const existingSchema = document.querySelectorAll('script[type="application/ld+json"]');
        existingSchema.forEach(script => script.remove());

        if (!events || events.length === 0) return;

        events.forEach(event => {
          const performerList = event.details[0].cast.map(name => ({
            "@type": "Person",
            "name": name
          }));
          const schemaData = {
            "@context": "https://schema.org",
            "@type": "MusicEvent",
            "name": event.title.replace(' | 2026', ''),
            "startDate": new Date(event.details[0].date.split(' - ')[0].split('.').reverse().join('-')).toISOString(),
            "location": {
              "@type": "Place",
              "name": "Arena di Verona",
              "address": {
                "@type": "PostalAddress",
                "streetAddress": "Piazza Bra, 1",
                "addressLocality": "Verona",
                "postalCode": "37121",
                "addressCountry": "IT"
              }
            },
            "url": event.url,
            "description": `Entradas para la ópera ${event.title.replace(' | 2026', '')} en la Arena de Verona.`,
            "organizer": {
              "@type": "Organization",
              "name": "Fondazione Arena di Verona",
              "url": "https://www.arena.it"
            },
            "performer": performerList,
            "offers": {
              "@type": "Offer",
              "url": event.details[0].buyTicketsLink,
              "priceCurrency": "EUR",
              "price": "0.00", // Precio genérico, ya que la API no lo proporciona
              "availability": "https://schema.org/InStock"
            }
          };

          const script = document.createElement('script');
          script.type = 'application/ld+json';
          script.innerHTML = JSON.stringify(schemaData, null, 2);
          document.head.appendChild(script);
        });
      }

      function renderEvents(events) {
        eventsContainer.innerHTML = '';
        if (!events || events.length === 0) {
          eventsContainer.innerHTML = `<p class="col-span-full text-center text-gray-500 text-xl mt-8">No se encontraron representaciones para los criterios de búsqueda seleccionados.</p>`;
          return;
        }

        events.forEach(event => {
          const performanceCount = event.details.length;
          const performanceText = performanceCount === 1 ? 'representación' : 'representaciones';

          // Elimina la fecha del título y, si es una edición específica, ajusta el formato
          const fullTitle = event.title.replace(' | 2026', '');
          let operaName = fullTitle;
          if (fullTitle.includes('Ed. ')) {
            const parts = fullTitle.split('Ed. ');
            operaName = `${parts[0].trim()} (${parts[1].trim()})`;
          }
          
          const detailsHtml = event.details.map(detail => {
            const castHtml = detail.cast.map(castMember => `<li>${castMember}</li>`).join('');
            const dateOnly = detail.date.split(' - ')[0];
            const formattedDate = dateOnly.replace(/\./g, '/');

            return `
              <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p class="text-lg text-gray-700"><span class="font-bold text-gray-900">Fecha:</span> ${formattedDate}</p>
                <p class="text-lg text-gray-600 mt-1 mb-2"><span class="font-bold text-gray-800">Cast:</span></p>
                <ul class="list-disc list-inside space-y-1">${castHtml}</ul>
                <div class="text-center mt-6">
                  <a href="${detail.buyTicketsLink}" target="_blank" class="btn-primary inline-flex items-center text-base font-medium" aria-label="Comprar entradas para la fecha ${formattedDate}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    Entradas
                  </a>
                </div>
              </div>
            `;
          }).join('');

          const eventCardHtml = `
            <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 p-6 flex flex-col h-full">
              <div class="bg-gradient-to-r from-[#003366] to-black p-2 rounded-lg mb-2 flex items-center justify-between">
                <div class="flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13m-6 0v6l-12-3v-13" />
                  </svg>
                  <h2 class="text-lg sm:text-xl font-bold text-white text-center ml-2 overflow-hidden whitespace-nowrap">${operaName}</h2>
                </div>
                <button class="text-white hover:text-yellow-400 info-icon" data-opera="${event.title.replace(' | 2026', '')}" aria-label="Ver descripción de la ópera">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
              </div>
              <p class="text-lg text-gray-500 mb-2"><strong>${performanceCount}</strong> ${performanceText} programada${performanceCount === 1 ? '' : 's'}.</p>
              <button onclick="window.open('${event.url}', '_blank')" class="btn-primary mt-3 mb-6 inline-flex items-center justify-center text-base font-medium" aria-label="Ver más detalles del evento">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Detalles
              </button>
              <div class="space-y-4 overflow-y-auto max-h-96 pr-2">${detailsHtml}</div>
            </div>
          `;
          eventsContainer.insertAdjacentHTML('beforeend', eventCardHtml);
        });

        // Add event listeners for the info buttons after rendering
        document.querySelectorAll('.info-icon').forEach(button => {
          button.addEventListener('click', (e) => {
            const operaName = e.currentTarget.dataset.opera;
            modalTitle.textContent = operaName;
            modalDescription.innerHTML = operaDescriptions[operaName] || 'No hay descripción disponible para esta ópera.';
            operaModal.style.display = 'block';
          });
        });
      }

      closeModalBtn.addEventListener('click', () => {
        operaModal.style.display = 'none';
      });

      window.addEventListener('click', (event) => {
        if (event.target == operaModal) {
          operaModal.style.display = 'none';
        }
      });

      async function fetchFestivalInfo() {
        try {
          const response = await fetch(festivalInfoUrl);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const info = await response.json();
          if (info.edition) {
            // Elimina el año "2026" si existe en el título
            const cleanTitle = info.edition.replace(/\s\d{4}$/, '');
            festivalEditionElement.textContent = cleanTitle;

            // Extraer el número de la edición del festival (ej. "103")
            const editionNumber = cleanTitle.match(/^\d+/)?.[0];
            if (editionNumber && footerEditionElement) {
              footerEditionElement.textContent = editionNumber + 'º';
            }
          }
        } catch (error) {
          console.error('Failed to fetch festival info:', error);
        }
      }

      async function fetchEvents() {
        // Muestra el estado de carga
        loadingState.classList.remove('hidden');
        eventsContainer.classList.add('hidden');
        errorMessage.classList.add('hidden');
        try {
          const response = await fetch(apiUrl);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();
          allEventsData = data;
          renderEvents(allEventsData);
          generateSchemaMarkup(allEventsData);
        } catch (error) {
          console.error('Failed to fetch events:', error);
          eventsContainer.innerHTML = '';
          errorMessage.classList.remove('hidden');
        } finally {
          // Oculta el estado de carga y muestra los eventos
          loadingState.classList.add('hidden');
          eventsContainer.classList.remove('hidden');
        }
      }

      function filterEvents() {
        const dateString = dateFilterInput.value;
        const daysOffset = parseInt(daysFilterInput.value, 10);
        const castFilter = castFilterInput.value.toLowerCase();
        let filteredEvents = allEventsData;
        let validDate = true;

        if (dateString) {
          if (isValidDate(dateString)) {
            validationMessage.classList.add('hidden');
            const filterDate = new Date(dateString);
            filterDate.setHours(0, 0, 0, 0);
            const startDate = new Date(filterDate); startDate.setDate(filterDate.getDate() - daysOffset); startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(filterDate); endDate.setDate(endDate.getDate() + daysOffset); endDate.setHours(0, 0, 0, 0);

            filteredEvents = filteredEvents.map(event => {
              const filteredDetails = event.details.filter(detail => {
                const dateParts = detail.date.split(' - ')[0].split('.');
                const detailDate = new Date(parseInt(dateParts[2], 10), parseInt(dateParts[1], 10) - 1, parseInt(dateParts[0], 10));
                detailDate.setHours(0, 0, 0, 0);
                return daysOffset === 0 ? detailDate.getTime() === filterDate.getTime() : detailDate.getTime() >= startDate.getTime() && detailDate.getTime() <= endDate.getTime();
              });
              if (filteredDetails.length > 0) return { ...event, details: filteredDetails };
              return null;
            }).filter(event => event !== null);
          } else {
            validationMessage.textContent = 'Formato de fecha no válido.';
            validationMessage.classList.remove('hidden');
            validDate = false;
          }
        }

        if (validDate) {
          if (castFilter) {
            filteredEvents = filteredEvents.map(event => {
              const filteredDetails = event.details.filter(detail => detail.cast.join(' ').toLowerCase().includes(castFilter));
              if (filteredDetails.length > 0) return { ...event, details: filteredDetails };
              return null;
            }).filter(event => event !== null);
          }

          filteredEvents.sort((a, b) => {
            const datePartsA = a.details[0].date.split(' - ')[0].split('.');
            const dateA = new Date(datePartsA[2], datePartsA[1] - 1, datePartsA[0]);
            const datePartsB = b.details[0].date.split(' - ')[0].split('.');
            const dateB = new Date(datePartsB[2], datePartsB[1] - 1, datePartsB[0]);
            return dateA.getTime() - dateB.getTime();
          });

          renderEvents(filteredEvents);
          generateSchemaMarkup(filteredEvents);
        }
      }

      filterButton.addEventListener('click', filterEvents);
      resetButton.addEventListener('click', () => {
        dateFilterInput.value = '';
        daysFilterInput.value = '3';
        castFilterInput.value = '';
        validationMessage.classList.add('hidden');
        daysFilterContainer.classList.add('hidden');
        renderEvents(allEventsData);
        generateSchemaMarkup(allEventsData);
      });

      dateFilterInput.addEventListener('input', () => {
        const dateString = dateFilterInput.value;
        if (isValidDate(dateString)) {
          daysFilterContainer.classList.remove('hidden');
          validationMessage.classList.add('hidden');
        } else {
          daysFilterContainer.classList.add('hidden');
          if (dateString !== '') {
            validationMessage.textContent = 'Formato de fecha no válido.';
            validationMessage.classList.remove('hidden');
          }
        }
      });

      document.addEventListener('DOMContentLoaded', () => {
        Promise.all([fetchFestivalInfo(), fetchEvents()]);
      });
    })();
  </script>
</body>
</html>
